<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BET300 ¬∑ Ruleta Segmentada</title>
<meta name="theme-color" content="#071022" />
<style>
:root{
  --bg:#071022;
  --panel:#0b1633;
  --panel2:#09122b;
  --border:#1e2a58;
  --text:#eaf0ff;
  --muted:#a8b3dd;
  --gold:#ffd166;
  --gold2:#ffb703;
  --cyan:#22d3ee;
  --wa:#25D366;

  /* Fluor */
  --neon:#39ff88;
  --neon2:#12ff6a;
  --neonShadow: 0 0 10px rgba(57,255,136,.55), 0 0 24px rgba(18,255,106,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto;
  color:var(--text);
  background:var(--bg);
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed;inset:0;z-index:-2;
  background:
    radial-gradient(900px 520px at 50% -12%, rgba(255,209,102,.12), transparent 60%),
    radial-gradient(700px 420px at 0% 0%, rgba(34,211,238,.14), transparent 55%),
    radial-gradient(700px 420px at 100% 0%, rgba(57,255,136,.10), transparent 55%),
    linear-gradient(180deg,#071022 0%,#060c1a 70%,#050916 100%);
}

/* Nieve */
.snow{position:fixed;inset:0;pointer-events:none;z-index:-1}
.snow i{
  position:absolute;top:-10px;border-radius:50%;
  background:rgba(255,255,255,.85);
  opacity:.8;filter:blur(.4px);
  animation:fall linear infinite;
}
@keyframes fall{
  0%{transform:translate3d(0,-10px,0)}
  100%{transform:translate3d(var(--drift,18px),110vh,0);opacity:0}
}

/* Layout */
.container{max-width:980px;margin:10px auto 92px;padding:0 12px}
.card{
  background: radial-gradient(120% 100% at 50% 0%, rgba(255,209,102,.08), transparent), var(--panel2);
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  box-shadow:0 16px 50px rgba(0,0,0,.42);
}
@media(max-width:520px){
  .container{padding:0 0 92px;margin:0}
  .card{border-radius:0;border-left:0;border-right:0}
}

/* Header compacto: 1 l√≠nea real (logo + segmentos + countdown) */
.topbar{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:nowrap;
  overflow:hidden;
  padding:6px 6px 10px;
}

.logoCenter{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  min-width:0;
}
.logoCenter img{
  height:46px; /* ‚úÖ adapta a tu SVG 600x180 perfecto */
  width:auto;
  display:block;
  filter:drop-shadow(0 6px 18px rgba(0,0,0,.55));
}
@media(max-width:420px){
  .logoCenter img{height:42px}
}

/* Segmentos arriba (sin scroll) */
.segments{
  display:flex;
  gap:8px;
  align-items:center;
}
.segBtn{
  appearance:none;border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  color:var(--muted);
  padding:8px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  white-space:nowrap;
  transition:transform .08s ease, filter .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}
.segBtn:hover{filter:brightness(1.08);transform:translateY(-1px)}
.segBtn.active{
  color:#06111f;
  background:linear-gradient(90deg,var(--neon),var(--neon2));
  border-color:rgba(57,255,136,.55);
  box-shadow: var(--neonShadow);
}

/* Countdown pill */
.pill{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  border-radius:999px;
  padding:8px 10px;
  font-size:12px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:8px;
  white-space:nowrap;
}
.count{
  display:inline-flex;
  padding:3px 9px;
  border-radius:999px;
  background:rgba(255,209,102,.12);
  border:1px solid rgba(255,209,102,.35);
  color:#ffe7a2;
  font-weight:900;
  font-variant-numeric:tabular-nums;
}

/* Grid */
.grid{display:grid;gap:12px}
@media(min-width:900px){ .grid{grid-template-columns:1.1fr .9fr} }

.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
}

/* Ruleta */
.stage{display:flex;justify-content:center;align-items:center}
.wrap{width:100%;max-width:520px;position:relative}
canvas{width:100%;height:auto;display:block}
.pointer{
  position:absolute;top:6px;left:50%;transform:translateX(-50%);
  border-left:16px solid transparent;border-right:16px solid transparent;
  border-bottom:26px solid var(--cyan);
  z-index:2;
  filter:drop-shadow(0 6px 14px rgba(34,211,238,.35));
}
@media(max-width:420px){
  .pointer{border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:22px solid var(--cyan);top:4px}
}

/* Info lateral */
h1,h2,p{margin:0 0 8px}
h1{font-size:18px}
.muted{color:var(--muted)}
.badge{
  display:inline-grid;place-items:center;
  min-width:84px;height:48px;
  border-radius:14px;
  background:radial-gradient(100% 100% at 50% 0%, rgba(255,209,102,.35), rgba(34,211,238,.18));
  border:1px solid rgba(255,255,255,.10);
  font-weight:1000;
  box-shadow:inset 0 0 14px rgba(255,209,102,.18);
}
.smallline{font-size:12px;color:var(--muted)}

/* CTA plataforma */
.platformBox{
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.14);
  background:rgba(255,255,255,.03);
  display:grid;
  gap:10px;
}
.ctaRow{display:flex;gap:10px;flex-wrap:wrap}
.aBtn{
  text-decoration:none;
  display:inline-flex;
  justify-content:center;
  align-items:center;
  gap:8px;
  padding:12px 14px;
  border-radius:14px;
  font-weight:1000;
  border:1px solid rgba(255,255,255,.10);
  cursor:pointer;
  user-select:none;
}
.aBtn.platform{
  background:linear-gradient(90deg,var(--gold2),var(--gold));
  color:#071022;
  box-shadow:0 10px 22px rgba(0,0,0,.35);
}
.aBtn.wa{
  background:linear-gradient(90deg,#19d36a,#25D366);
  color:#04120a;
  box-shadow:0 10px 22px rgba(0,0,0,.35);
}

/* Dock inferior */
.dock{
  position:fixed;left:0;right:0;bottom:0;z-index:30;
  background:linear-gradient(180deg, rgba(7,16,34,0) 0%, rgba(7,16,34,.84) 20%, rgba(7,16,34,.95) 100%);
  padding:10px 12px 12px;
  display:flex;gap:10px;
}
.btn{
  appearance:none;border:none;
  width:100%;
  padding:14px 14px;
  border-radius:16px;
  font-weight:1000;
  cursor:pointer;
  box-shadow:0 10px 26px rgba(0,0,0,.4);
  transition:transform .06s ease, filter .12s ease;
}
.btn:active{transform:translateY(0)}
.btn:hover{filter:brightness(1.06);transform:translateY(-1px)}
.btn:disabled{opacity:.55;cursor:not-allowed;transform:none;filter:none}

/* ‚úÖ Bot√≥n Girar rojo brillante */
#spinBtn{
  background:linear-gradient(90deg,#ff2e2e,#ff0038);
  color:#06111f;
}

/* Reclamar (WA) */
#claimBtn{
  background:linear-gradient(90deg,#22c55e,#25D366);
  color:#04120a;
}

/* Confetti */
.confetti{position:fixed;inset:0;pointer-events:none;z-index:60}
.confetti i{position:absolute;top:-20px;width:10px;height:14px;border-radius:2px;opacity:0;animation:confFall 1.6s linear forwards}
@keyframes confFall{8%{opacity:1}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}

/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:80}
.modal.show{display:flex}
.modalCard{
  width:min(520px,92vw);
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  box-shadow:0 24px 64px rgba(0,0,0,.55);
}
.modalHead{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.modalHead h3{margin:0;font-size:18px}
.closeX{margin-left:auto;cursor:pointer;opacity:.85}
.closeX:hover{opacity:1}
.rowLine{
  display:flex;justify-content:space-between;gap:10px;align-items:center;
  border:1px dashed rgba(255,255,255,.12);
  border-radius:14px;
  padding:10px 12px;
  margin-bottom:8px;
}
.k{color:var(--muted);font-size:13px}
.v{font-weight:1000}
.modalActions{display:flex;gap:10px;margin-top:10px}
.modalActions .btn{padding:12px 14px;border-radius:14px}
.btnGhost{
  background:transparent;
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
}
</style>
</head>
<body>

<div class="snow" id="snow"></div>
<div id="confetti" class="confetti" aria-hidden="true"></div>

<!-- Modal premio -->
<div id="prizeModal" class="modal" role="dialog" aria-modal="true">
  <div class="modalCard">
    <div class="modalHead">
      <h3>üéÅ Premio asignado</h3>
      <span class="closeX" id="closeX">‚úñ</span>
    </div>
    <div class="rowLine"><span class="k">Segmento</span><span class="v" id="mSeg">‚Äî</span></div>
    <div class="rowLine"><span class="k">Premio</span><span class="v" id="mPrize">‚Äî</span></div>
    <div class="rowLine"><span class="k">C√≥digo</span><span class="v" id="mCode">‚Äî</span></div>
    <div class="rowLine"><span class="k">Fecha/Hora</span><span class="v" id="mTs">‚Äî</span></div>

    <div class="modalActions">
      <button class="btn" id="mWa" style="background:linear-gradient(90deg,#22c55e,#25D366);color:#04120a">üì≤ Reclamar por WhatsApp</button>
      <a class="btn aBtn platform" id="mGo" href="https://bet300.biz" target="_blank" rel="noopener" style="text-decoration:none;display:inline-flex">üéÆ Ir a la plataforma</a>
      <button class="btn btnGhost" id="mClose">Cerrar</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">

    <!-- Header compacto -->
    <div class="topbar">
      <div class="segments" id="segments">
        <button class="segBtn" data-seg="basic">B√ÅSICO</button>
        <button class="segBtn" data-seg="pro">PRO</button>
        <button class="segBtn" data-seg="vip">VIP</button>
      </div>

      <div class="logoCenter">
        <!-- ‚úÖ tu SVG -->
        <img src="img/logo-navidad.svg" alt="BET300">
      </div>

      <div class="pill">‚è± <span>V√°lido hoy</span> <span class="count" id="countdown">--:--</span></div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="stage">
          <div class="wrap">
            <canvas id="wheel" width="620" height="620"></canvas>
            <div class="pointer" aria-hidden="true"></div>
          </div>
        </div>
        <p class="muted" style="margin-top:10px;font-size:13px">
          Eleg√≠ un segmento arriba y gir√°. <b>1 vez por d√≠a</b>. Premios: montos + porcentajes.
        </p>
      </div>

      <div class="panel">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div>
            <div class="badge" id="badge">‚Äî</div>
            <div class="smallline" id="stampLine"></div>
          </div>
          <div style="flex:1;min-width:220px">
            <h1 id="title">Eleg√≠ tu segmento para habilitar el giro</h1>
            <p class="muted" id="subtitle">Los premios se acreditan con tu <b>pr√≥xima carga m√≠nima</b>.</p>
          </div>
        </div>

        <div class="platformBox">
          <div>
            <b>Acceso directo</b>
            <div class="muted" style="font-size:13px;margin-top:4px">
              Pod√©s entrar a la plataforma ahora. Si quer√©s control/registro, us√° ‚ÄúReclamar por WhatsApp‚Äù.
            </div>
          </div>
          <div class="ctaRow">
            <a class="aBtn platform" href="https://bet300.biz" target="_blank" rel="noopener">üéÆ Entrar a la plataforma</a>
            <a class="aBtn wa" id="waQuick" href="#" target="_blank" rel="noopener">üì≤ Reclamar por WhatsApp</a>
          </div>

          <div class="muted" style="font-size:12px">
            VIP: tope recomendado <b>30%</b> para cargas hasta <b>$200.000</b>.
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Dock fijo -->
<div class="dock">
  <button id="spinBtn" class="btn" disabled>üéØ Girar</button>
  <button id="claimBtn" class="btn" disabled>üì≤ Reclamar</button>
</div>

<script>
/* =========================
   CONFIG PCs (5 par√°metros)
   ========================= */
const PLATFORM_LINK = "https://bet300.biz"; // √∫nico para las 5

// WhatsApp gen√©ricos para que reemplaces despu√©s
const WP_NUMBERS = {
  pc1: "5491100000001",
  pc2: "5491100000002",
  pc3: "5491100000003",
  pc4: "5491100000004",
  pc5: "5491100000005"
};

function normalizeWP(n){
  const s = String(n).replace(/[^\d+]/g,"");
  return s.startsWith("+") ? s.slice(1) : s;
}
const params = new URLSearchParams(location.search);
const pcParam = (params.get("pc") || "1").trim();
const pcMatch = /^[1-5]$/.test(pcParam) ? pcParam : "1";
const pcKey = "pc" + pcMatch;
const WP = normalizeWP(WP_NUMBERS[pcKey]);

/* =========================
   Antifraude
   ========================= */
const SALT = "bet300-ruleta-seg-v1";
function ensureDeviceId(){
  let id = localStorage.getItem("device_id");
  if(!id){
    id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`);
    localStorage.setItem("device_id", id);
  }
  return id;
}
const DEVICE_ID = ensureDeviceId();

function todayKey(){
  const n=new Date();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}
async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeClaimCode(seg, prizeLabel){
  const base = `${DEVICE_ID}|${todayKey()}|${seg}|${prizeLabel}|pc:${pcMatch}|${SALT}`;
  const hex = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}

/* =========================
   Segmentos + premios
   ========================= */
const SEGMENTS = {
  basic: {
    name: "B√ÅSICO",
    prizes: [
      {type:"money", value:1000},
      {type:"money", value:2000},
      {type:"money", value:3000},
      {type:"money", value:5000},
      {type:"money", value:10000},
      {type:"percent", value:20},
      {type:"percent", value:30},
      {type:"percent", value:40},
      {type:"percent", value:50},
    ]
  },
  pro: {
    name: "PRO",
    prizes: [
      {type:"money", value:5000},
      {type:"money", value:10000},
      {type:"money", value:15000},
      {type:"money", value:20000},
      {type:"percent", value:30},
      {type:"percent", value:40},
      {type:"percent", value:50},
    ]
  },
  vip: {
    name: "VIP",
    prizes: [
      {type:"money", value:10000},
      {type:"money", value:15000},
      {type:"money", value:20000},
      {type:"percent", value:30},
      {type:"percent", value:40},
      {type:"percent", value:50},
    ]
  }
};

// Intercalado (montos y % para que quede prolijo)
function interleavePrizes(arr){
  const money = arr.filter(x=>x.type==="money");
  const perc  = arr.filter(x=>x.type==="percent");
  const out=[];
  const m = Math.max(money.length, perc.length);
  for(let i=0;i<m;i++){
    if(i<money.length) out.push(money[i]);
    if(i<perc.length)  out.push(perc[i]);
  }
  return out;
}

function money(n){ return "$"+n.toLocaleString("es-AR"); }
function label(p){ return p.type==="money" ? money(p.value) : `${p.value}%`; }
function subtitleHTML(p){
  return p.type==="money"
    ? `Recib√≠s <b>${money(p.value)} extra</b> con tu pr√≥xima carga.`
    : `Recib√≠s un <b>${p.value}% extra</b> con tu pr√≥xima carga.`;
}

/* =========================
   UI refs
   ========================= */
const wheel=document.getElementById("wheel");
const ctx=wheel.getContext("2d");
const spinBtn=document.getElementById("spinBtn");
const claimBtn=document.getElementById("claimBtn");
const badge=document.getElementById("badge");
const title=document.getElementById("title");
const subtitle=document.getElementById("subtitle");
const stampLine=document.getElementById("stampLine");

const confetti=document.getElementById("confetti");

const prizeModal=document.getElementById("prizeModal");
const closeX=document.getElementById("closeX");
const mClose=document.getElementById("mClose");
const mSeg=document.getElementById("mSeg");
const mPrize=document.getElementById("mPrize");
const mCode=document.getElementById("mCode");
const mTs=document.getElementById("mTs");
const mWa=document.getElementById("mWa");
const mGo=document.getElementById("mGo");
const waQuick=document.getElementById("waQuick");

mGo.href = PLATFORM_LINK;

function openModal(segName, prizeLabel, code, ts){
  mSeg.textContent = segName;
  mPrize.textContent = prizeLabel;
  mCode.textContent = code;
  mTs.textContent = ts;
  prizeModal.classList.add("show");
}
function closeModal(){ prizeModal.classList.remove("show"); }
closeX.onclick=closeModal; mClose.onclick=closeModal;
prizeModal.addEventListener("click",(e)=>{ if(e.target===prizeModal) closeModal(); });

function whatsappText(segName, prizeLabel, code, ts){
  return `Hola, gan√© ${prizeLabel} en la Ruleta (${segName}) y quiero reclamarlo. C√≥digo: ${code} ¬∑ ${ts}`;
}

/* =========================
   Estado (segmento + giro)
   ========================= */
let currentSeg = null;
let PRIZES = [];
let angle = 0;
let spinning = false;
let cx,cy,r,cssW=0;

const COLORS = [
  "#22d3ee","#ffd166","#39ff88","#a78bfa","#ff4d6d",
  "#7c59ff","#00d1ff","#ffb703","#16e2b6","#ff6ad5",
  "#8ab6ff","#ffe08a","#4be1a0","#ff9bd1"
];

function setSize(){
  const dpr=window.devicePixelRatio||1;
  const wrapW = Math.min(520, Math.max(280, document.querySelector(".wrap").getBoundingClientRect().width));
  cssW=wrapW;
  wheel.width=Math.floor(wrapW*dpr);
  wheel.height=Math.floor(wrapW*dpr);
  wheel.style.width=wrapW+"px";
  wheel.style.height=wrapW+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
  cx=wheel.width/dpr/2;
  cy=wheel.height/dpr/2;
  r=Math.min(cx,cy)-10;
}
addEventListener("resize",()=>{ clearTimeout(window.__wTo); window.__wTo=setTimeout(setSize,120); });

function draw(){
  ctx.clearRect(0,0,wheel.width,wheel.height);
  if(!PRIZES.length){
    // placeholder
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.fillStyle="rgba(255,255,255,.04)"; ctx.fill();
    ctx.strokeStyle="rgba(255,255,255,.10)"; ctx.lineWidth=3; ctx.stroke();
    ctx.fillStyle="rgba(255,255,255,.55)";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.font="800 18px system-ui";
    ctx.fillText("Eleg√≠ un segmento", cx, cy);
    return;
  }

  const n=PRIZES.length;
  const arc=Math.PI*2/n;

  const font = cssW<=340 ? "900 18px system-ui" :
               cssW<=420 ? "900 22px system-ui" :
                           "900 26px system-ui";

  for(let i=0;i<n;i++){
    const s=angle+i*arc, e=s+arc;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,s,e);
    ctx.closePath();
    ctx.fillStyle=COLORS[i%COLORS.length];
    ctx.fill();

    ctx.strokeStyle="rgba(8,12,26,.35)";
    ctx.lineWidth=2;
    ctx.stroke();

    const txt=label(PRIZES[i]);
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(s+arc/2);
    ctx.textAlign="right";
    ctx.textBaseline="middle";
    ctx.font=font;
    ctx.fillStyle="#06111f";
    ctx.fillText(txt, r-18, 0);
    ctx.restore();
  }

  // aro
  ctx.beginPath();
  ctx.arc(cx,cy,r*1.02,0,Math.PI*2);
  ctx.lineWidth=Math.max(8,r*0.04);
  ctx.strokeStyle="rgba(255,255,255,.14)";
  ctx.stroke();

  // centro
  const rc = Math.max(30, r*0.10);
  ctx.beginPath();
  ctx.arc(cx,cy,rc,0,Math.PI*2);
  ctx.fillStyle="#071022";
  ctx.fill();
  ctx.strokeStyle="rgba(255,209,102,.35)";
  ctx.lineWidth=Math.max(2,rc*0.10);
  ctx.stroke();
}

(function loop(){
  draw();
  requestAnimationFrame(loop);
})();

function norm(rad){
  const T=Math.PI*2;
  return ((rad%T)+T)%T;
}
function winnerIndexByAngle(a){
  const n=PRIZES.length;
  const arc=(Math.PI*2)/n;
  const pointer=Math.PI*1.5;
  const rel=norm(pointer-a);
  return Math.floor(rel/arc)%n;
}
function animateTo(target,ms,cb){
  const start=performance.now();
  const from=angle;
  (function step(t){
    const k=Math.min(1,(t-start)/ms);
    const ease=1-Math.pow(1-k,3);
    angle=from+(target-from)*ease;
    if(k<1) requestAnimationFrame(step);
    else cb&&cb();
  })(start);
}

/* =========================
   Persistencia 1 vez por d√≠a
   ========================= */
function restoreDaily(){
  const today=todayKey();
  const stored=localStorage.getItem("ruleta_date");
  if(stored && stored!==today){
    ["ruleta_done","ruleta_prize","ruleta_code","ruleta_ts","ruleta_seg"].forEach(k=>localStorage.removeItem(k));
    localStorage.setItem("ruleta_date",today);
  }else if(!stored){
    localStorage.setItem("ruleta_date",today);
  }
}

function applySavedPrizeIfAny(){
  const done = localStorage.getItem("ruleta_done")==="1";
  const saved = localStorage.getItem("ruleta_prize");
  const seg = localStorage.getItem("ruleta_seg");
  if(done && saved && seg){
    currentSeg = seg;
    PRIZES = interleavePrizes(SEGMENTS[seg].prizes);

    // activar bot√≥n segmento en UI
    document.querySelectorAll(".segBtn").forEach(b=>{
      b.classList.toggle("active", b.dataset.seg===seg);
    });

    const p = JSON.parse(saved);
    const prizeLabel = label(p);
    const code = localStorage.getItem("ruleta_code") || "‚Äî";
    const ts   = localStorage.getItem("ruleta_ts") || tsString();

    badge.textContent = prizeLabel;
    title.textContent = "üéâ ¬°Premio obtenido!";
    subtitle.innerHTML = subtitleHTML(p);
    stampLine.textContent = `C√≥digo: ${code} ¬∑ ${ts}`;

    // botones
    spinBtn.disabled = true;
    claimBtn.disabled = false;

    const segName = SEGMENTS[seg].name;
    const msg = whatsappText(segName, prizeLabel, code, ts);
    claimBtn.onclick = ()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
    waQuick.href = `https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;

    // modal link
    mWa.onclick = ()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
    return true;
  }
  return false;
}

/* =========================
   Segment selection (‚úÖ neon)
   ========================= */
const segWrap = document.getElementById("segments");
segWrap.addEventListener("click",(e)=>{
  const btn = e.target.closest(".segBtn");
  if(!btn) return;

  // si ya gir√≥ hoy, permitimos ver segmentos pero no habilitamos spin
  const already = localStorage.getItem("ruleta_done")==="1";

  currentSeg = btn.dataset.seg;
  document.querySelectorAll(".segBtn").forEach(b=>b.classList.toggle("active", b===btn));

  PRIZES = interleavePrizes(SEGMENTS[currentSeg].prizes);

  title.textContent = `Segmento ${SEGMENTS[currentSeg].name} seleccionado`;
  subtitle.innerHTML = `Premios seg√∫n tu nivel. Gir√°s <b>1 vez por d√≠a</b>.`;
  badge.textContent = "‚Äî";
  stampLine.textContent = "";

  // ‚úÖ destrabamos ‚ÄúGirar‚Äù
  spinBtn.disabled = already ? true : false;
  claimBtn.disabled = true;
});

/* =========================
   Confetti
   ========================= */
function confettiBurst(){
  confetti.innerHTML="";
  const n=30;
  for(let i=0;i<n;i++){
    const p=document.createElement("i");
    p.style.left=(Math.random()*100)+"vw";
    p.style.animationDelay=(Math.random()*0.5)+"s";
    p.style.background = Math.random()<.5
      ? "linear-gradient(#80ffea,#4e9cff)"
      : "linear-gradient(#ffd166,#ff0038)";
    confetti.appendChild(p);
  }
  setTimeout(()=>confetti.innerHTML="",1800);
}

/* =========================
   Spin
   ========================= */
spinBtn.addEventListener("click", async ()=>{
  // ‚úÖ Si est√° ‚Äúsombreado‚Äù es porque sigue disabled: ac√° lo bloqueamos con mensaje claro
  if(spinBtn.disabled){
    if(!currentSeg){ alert("Primero eleg√≠ un segmento (B√ÅSICO / PRO / VIP)."); return; }
    if(localStorage.getItem("ruleta_done")==="1"){ alert("Ya usaste tu giro de hoy."); return; }
    return;
  }
  if(spinning) return;

  if(!currentSeg){
    alert("Eleg√≠ un segmento arriba para habilitar el giro.");
    return;
  }
  if(localStorage.getItem("ruleta_done")==="1"){
    alert("Ya usaste tu giro de hoy.");
    return;
  }

  spinning=true;
  spinBtn.disabled=true;
  claimBtn.disabled=true;

  // animaci√≥n
  const extra=5+Math.random()*1.6;
  const offset=Math.random()*Math.PI*2;
  const final=angle+(Math.PI*2*extra)+offset;

  animateTo(final, 2900, async ()=>{
    angle=final;

    const idx = winnerIndexByAngle(angle);
    const prize = PRIZES[idx];
    const prizeLabel = label(prize);

    const ts = tsString(new Date());
    const segName = SEGMENTS[currentSeg].name;
    const code = await makeClaimCode(currentSeg, prizeLabel);

    // persistir
    localStorage.setItem("ruleta_done","1");
    localStorage.setItem("ruleta_seg", currentSeg);
    localStorage.setItem("ruleta_prize", JSON.stringify(prize));
    localStorage.setItem("ruleta_code", code);
    localStorage.setItem("ruleta_ts", ts);
    localStorage.setItem("ruleta_date", todayKey());

    // UI
    badge.textContent = prizeLabel;
    title.textContent = "üéâ ¬°Premio obtenido!";
    subtitle.innerHTML = subtitleHTML(prize);
    stampLine.textContent = `C√≥digo: ${code} ¬∑ ${ts}`;

    // botones WA
    const msg = whatsappText(segName, prizeLabel, code, ts);
    claimBtn.disabled=false;
    claimBtn.onclick = ()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
    waQuick.href = `https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
    mWa.onclick = ()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;

    confettiBurst();
    openModal(segName, prizeLabel, code, ts);

    spinning=false;
  });
});

// Bot√≥n Reclamar (si todav√≠a no gir√≥) => aviso
claimBtn.addEventListener("click", ()=>{
  if(claimBtn.disabled) alert("Primero gir√° para obtener un premio.");
});

/* =========================
   Countdown
   ========================= */
function endOfDay(){
  const n=new Date();
  return new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,0,0).getTime();
}
function tickCountdown(){
  const ms=endOfDay()-Date.now();
  const total=Math.max(0,Math.floor(ms/1000));
  const h=Math.floor(total/3600), m=Math.floor((total%3600)/60), s=total%60;
  document.getElementById("countdown").textContent =
    `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}
setInterval(tickCountdown,1000);

/* =========================
   Snow
   ========================= */
function setupSnow(){
  const snow=document.getElementById("snow");
  snow.innerHTML="";
  const flakes=42;
  for(let i=0;i<flakes;i++){
    const f=document.createElement("i");
    const size=2.5+Math.random()*4.5;
    f.style.width=f.style.height=size+"px";
    f.style.left=(Math.random()*100)+"vw";
    f.style.opacity=(0.4+Math.random()*0.6);
    f.style.animationDuration=(7+Math.random()*6)+"s";
    f.style.animationDelay=(Math.random()*-10)+"s";
    f.style.setProperty("--drift",(Math.random()*40-20)+"px");
    snow.appendChild(f);
  }
}

/* =========================
   Init
   ========================= */
function init(){
  setSize();
  setupSnow();
  restoreDaily();
  tickCountdown();

  const restored = applySavedPrizeIfAny();

  // estado inicial ‚ÄúGirar‚Äù:
  // - si restaur√≥ premio => spin disabled (ok)
  // - si no hay premio => spin disabled hasta elegir segmento
  if(!restored){
    spinBtn.disabled = true; // ‚úÖ evita ‚Äútrabado raro‚Äù: est√° intencional hasta que elijan segmento
    claimBtn.disabled = true;
  }
}
init();
</script>
</body>
</html>
