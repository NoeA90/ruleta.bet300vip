<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BET300 ¬∑ Ruleta Navidad</title>
<meta name="theme-color" content="#070A16"/>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg0:#050818;
  --bg1:#0A1026;

  --panel:rgba(10,15,35,.62);
  --panel2:rgba(8,12,28,.55);
  --border:rgba(255,255,255,.10);

  --text:#F3F7FF;
  --muted:rgba(243,247,255,.72);

  --gold1:#FFD166;
  --gold2:#FFB703;

  --red1:#FF1E2D;      /* rojo brillante */
  --red2:#FF5A3C;

  --cyan1:#32F5FF;
  --cyan2:#2EA8FF;

  --green1:#2AF598;
  --green2:#00C853;

  --shadow: 0 18px 55px rgba(0,0,0,.58);
  --shadow2: 0 10px 28px rgba(0,0,0,.40);
  --radius: 20px;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(900px 520px at 20% -10%, rgba(255,209,102,.16), transparent 60%),
    radial-gradient(720px 420px at 100% 0%, rgba(46,168,255,.18), transparent 60%),
    radial-gradient(720px 420px at 0% 100%, rgba(42,245,152,.14), transparent 60%),
    linear-gradient(180deg,var(--bg1) 0%, var(--bg0) 70%);
  overflow-x:hidden;
}

/* glow suave */
body::before{
  content:"";
  position:fixed; inset:0; z-index:-2;
  background:
    radial-gradient(900px 600px at 50% -20%, rgba(255,255,255,.08), transparent 60%),
    radial-gradient(650px 420px at 0% 100%, rgba(255,30,45,.10), transparent 60%),
    radial-gradient(650px 420px at 100% 100%, rgba(50,245,255,.10), transparent 60%);
  pointer-events:none;
}

/* Nieve */
.snow{
  position:fixed; inset:0;
  pointer-events:none;
  z-index:0;
}
.snow i{
  position:absolute; top:-12px;
  width:6px; height:6px;
  background:rgba(255,255,255,.92);
  border-radius:50%;
  filter:blur(.35px);
  opacity:.85;
  animation: fall linear infinite;
}
@keyframes fall{
  0%{ transform: translate3d(0,-12px,0); opacity:0 }
  10%{ opacity:.85 }
  100%{ transform: translate3d(var(--drift,18px), 112vh,0); opacity:0 }
}

/* Confetti */
.confetti{
  position:fixed; inset:0; pointer-events:none; z-index:90;
}
.confetti i{
  position:absolute; top:-30px;
  width:10px; height:14px;
  border-radius:2px;
  opacity:0;
  animation: confFall 1.55s linear forwards;
}
@keyframes confFall{
  8%{ opacity:1 }
  100%{ transform: translateY(112vh) rotate(360deg); opacity:0 }
}

.container{
  position:relative;
  z-index:1;
  max-width: 980px;
  margin: 0 auto;
  padding: 16px 14px 120px;
}

/* TOP */
.top{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  padding:12px 12px;
  border-radius: 18px;
  background: var(--panel);
  border: 1px solid var(--border);
  box-shadow: var(--shadow2);
  backdrop-filter: blur(10px);
}

.brand{
  display:flex; align-items:center; gap:12px;
  min-width: 260px;
}
.brand img{
  height: 44px; width:auto; display:block;
  filter: drop-shadow(0 12px 20px rgba(0,0,0,.55));
}
.brandText{display:flex;flex-direction:column;gap:3px}
.brandText .t1{
  font-weight:900; letter-spacing:.05em; font-size:14px; opacity:.95;
}
.brandText .t2{
  font-weight:900;
  font-size:12px;
  letter-spacing:.24em;
  color: rgba(255,209,102,.92);
  text-transform:uppercase;
}

.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(255,209,102,.10), rgba(46,168,255,.10));
  border:1px solid rgba(255,255,255,.10);
  color: var(--muted);
  font-size:12px;
  user-select:none;
}
.pill b{
  color: var(--gold1);
  font-variant-numeric: tabular-nums;
  background: rgba(0,0,0,.25);
  padding:4px 10px;
  border-radius: 999px;
  border:1px solid rgba(255,209,102,.22);
}
.pill.btn{
  cursor:pointer;
  transition: transform .08s ease, filter .12s ease;
}
.pill.btn:hover{ transform: translateY(-1px); filter: brightness(1.08); }

.right{
  margin-left:auto;
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
}

a.btnLink{
  text-decoration:none;
  color:#120A10;
  font-weight:900;
  padding:10px 12px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(90deg, var(--red1), var(--red2));
  box-shadow: 0 14px 30px rgba(255,30,45,.22), 0 12px 30px rgba(0,0,0,.40);
  display:inline-flex; gap:8px; align-items:center;
  transition: transform .08s ease, filter .12s ease;
}
a.btnLink:hover{ transform: translateY(-1px); filter: brightness(1.06); }
a.btnLink:focus-visible{ outline:2px solid rgba(255,209,102,.85); outline-offset:2px; }

/* MAIN */
.grid{
  margin-top: 12px;
  display:grid;
  grid-template-columns: 1.05fr .95fr;
  gap:12px;
}
@media(max-width:900px){ .grid{grid-template-columns:1fr} .brand{min-width:auto} }

.card{
  border-radius: var(--radius);
  background: var(--panel);
  border:1px solid var(--border);
  box-shadow: var(--shadow);
  backdrop-filter: blur(12px);
  overflow:hidden;
  position:relative;
}
.card::before{
  content:"";
  position:absolute; inset:-2px;
  background:
    radial-gradient(520px 260px at 20% 0%, rgba(255,209,102,.14), transparent 60%),
    radial-gradient(520px 260px at 100% 25%, rgba(46,168,255,.14), transparent 60%);
  pointer-events:none;
}
.inner{ position:relative; padding: 14px; }

.h1{ margin:0 0 8px; font-size: 20px; font-weight: 900; }
.muted{ color: var(--muted); font-size: 13px; line-height:1.35; }

/* WHEEL */
.wheelWrap{
  display:grid; place-items:center;
  padding: 12px 10px 14px;
}
.wheelStage{
  width: min(560px, 96vw);
  aspect-ratio: 1 / 1;
  position:relative;
  display:grid;
  place-items:center;
  padding: 18px;                 /* aire (clave) */
  border-radius: 26px;
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.15));
  border:1px solid rgba(255,255,255,.10);
  box-shadow: 0 18px 45px rgba(0,0,0,.48);
}
@media(max-width:520px){
  .wheelStage{ padding: 14px; border-radius: 22px; }
}

/* Rim 3D */
.rim{
  position:absolute; inset: 16px;
  border-radius: 999px;
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.18), transparent 45%),
    radial-gradient(circle at 70% 80%, rgba(46,168,255,.12), transparent 48%),
    linear-gradient(180deg, rgba(255,209,102,.16), rgba(255,255,255,.05));
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.12),
    inset 0 -22px 44px rgba(0,0,0,.35);
  filter: blur(.15px);
}

canvas#wheel{
  width: 100%;
  height: 100%;
  display:block;
  border-radius: 999px;
  position:relative;
  z-index:2;
  filter: drop-shadow(0 22px 32px rgba(0,0,0,.58));
}

/* bulbs */
.bulbs{
  position:absolute;
  inset: 10px;
  z-index:3;
  pointer-events:none;
}
.bulbs i{
  position:absolute;
  width:8px;height:8px;border-radius:50%;
  box-shadow:0 0 10px rgba(255,255,255,.55);
  opacity:.65;
  animation: bulbOn 1.1s infinite;
}
@keyframes bulbOn{
  0%{opacity:.35; transform:scale(.92)}
  50%{opacity:1; transform:scale(1)}
  100%{opacity:.35; transform:scale(.92)}
}

/* pointer */
.pointer{
  position:absolute;
  top: 6px;
  left:50%;
  transform: translateX(-50%);
  z-index: 6;
  width: 0;
  height: 0;
  border-left: 16px solid transparent;
  border-right: 16px solid transparent;
  border-bottom: 30px solid rgba(255,209,102,.95);
  filter: drop-shadow(0 10px 10px rgba(0,0,0,.55));
}
.pointer::after{
  content:"";
  position:absolute;
  left:-9px; top: 8px;
  width:18px; height:18px;
  border-radius:999px;
  background:
    radial-gradient(circle at 35% 35%, rgba(255,255,255,.25), transparent 55%),
    linear-gradient(180deg, rgba(255,30,45,.95), rgba(255,90,60,.95));
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 8px 16px rgba(0,0,0,.45);
}

/* center cap w/logo */
.centerCap{
  position:absolute;
  width: 22%;
  aspect-ratio: 1/1;
  border-radius:999px;
  z-index:7;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 45%),
    linear-gradient(180deg, rgba(10,15,35,.92), rgba(0,0,0,.45));
  border:1px solid rgba(255,255,255,.12);
  box-shadow: inset 0 0 0 6px rgba(255,209,102,.10),
              0 10px 20px rgba(0,0,0,.45);
  display:grid;
  place-items:center;
}
.centerCap img{
  width: 72%;
  height:auto;
  filter: drop-shadow(0 10px 16px rgba(0,0,0,.55));
}

/* Right panel */
.statRow{
  display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
  margin-bottom:10px;
}
.badgePrize{
  min-width: 140px;
  padding: 10px 12px;
  border-radius: 14px;
  background: linear-gradient(90deg, rgba(255,209,102,.18), rgba(46,168,255,.18));
  border: 1px solid rgba(255,255,255,.12);
  font-weight: 900;
  text-align:center;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
.bigTitle{ margin:0; font-size: 26px; font-weight: 900; }
@media(max-width:520px){ .bigTitle{ font-size:22px; } }

.panelBox{
  margin-top:10px;
  padding:12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.10);
  background: var(--panel2);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
}
.panelBox h3{
  margin:0 0 6px;
  font-size: 14px;
  color: rgba(243,247,255,.90);
}
.panelBox p{
  margin:0;
  font-size: 13px;
  color: var(--muted);
  line-height: 1.35;
}
.smallCode{
  margin-top: 8px;
  font-size: 12px;
  color: rgba(243,247,255,.78);
}

/* footer links */
.footerLinks{
  display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;
}
.footerLinks a{
  flex: 1 1 220px;
  text-decoration:none;
  text-align:center;
  padding: 12px 12px;
  border-radius: 16px;
  font-weight: 900;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(8,12,28,.55);
  color: rgba(243,247,255,.92);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
}
.footerLinks a:hover{ filter: brightness(1.06); }

/* Dock */
.dock{
  position: fixed;
  left:0; right:0; bottom:0;
  z-index:60;
  padding: 10px 12px 12px;
  background: linear-gradient(180deg, rgba(7,10,22,0) 0%, rgba(7,10,22,.85) 30%, rgba(7,10,22,.96) 100%);
  display:flex;
  gap:10px;
}

button.btn{
  width:100%;
  border:none;
  cursor:pointer;
  padding: 14px 14px;
  border-radius: 16px;
  font-weight: 900;
  letter-spacing:.01em;
  box-shadow: 0 16px 34px rgba(0,0,0,.45);
  transition: transform .07s ease, filter .12s ease;
}
button.btn:hover{ transform: translateY(-1px); filter:brightness(1.05); }
button.btn:active{ transform: translateY(0); }
button.btn:disabled{ opacity:.55; cursor:not-allowed; }

.btnSpin{
  color:#160A10;
  background: linear-gradient(90deg, var(--gold1), var(--gold2));
}
.btnClaim{
  color:#10090E;
  background: linear-gradient(90deg, var(--red1), var(--red2)); /* rojo brillante */
}

/* Modal */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  z-index:120;
  background: rgba(0,0,0,.60);
  backdrop-filter: blur(7px);
}
.modal.show{ display:flex; }
.modalCard{
  width: min(520px, 92vw);
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(10,15,35,.84);
  box-shadow: 0 24px 70px rgba(0,0,0,.60);
  overflow:hidden;
}
.modalTop{
  padding: 14px 14px 10px;
  display:flex; align-items:center; gap:10px;
  border-bottom:1px solid rgba(255,255,255,.10);
}
.modalTop h2{ margin:0; font-size: 18px; font-weight: 900; }
.closeX{ margin-left:auto; cursor:pointer; opacity:.85; font-weight:900; }
.closeX:hover{ opacity:1; }
.modalBody{ padding: 12px 14px 14px; display:grid; gap:10px; }
.row{
  display:flex; justify-content:space-between; gap:10px;
  padding:10px 12px;
  border-radius: 14px;
  border:1px dashed rgba(255,255,255,.16);
  background: rgba(0,0,0,.18);
}
.row .k{ color: rgba(243,247,255,.75); font-size: 12px; }
.row .v{ font-weight: 900; }
.modalActions{ display:flex; gap:10px; margin-top: 4px; }
.modalActions button{ width:100%; }

.btnGhost{
  background: transparent;
  color: var(--text);
  border: 1px solid rgba(255,255,255,.16);
  box-shadow:none;
}
</style>
</head>

<body>
<div class="snow" id="snow" aria-hidden="true"></div>
<div class="confetti" id="confetti" aria-hidden="true"></div>

<!-- MODAL -->
<div class="modal" id="modal" role="dialog" aria-modal="true">
  <div class="modalCard">
    <div class="modalTop">
      <h2>üéÅ Premio obtenido</h2>
      <div class="closeX" id="closeX">‚úñ</div>
    </div>
    <div class="modalBody">
      <div class="row"><div class="k">Premio</div><div class="v" id="mPrize">‚Äî</div></div>
      <div class="row"><div class="k">C√≥digo antifraude</div><div class="v" id="mCode">‚Äî</div></div>
      <div class="row"><div class="k">Fecha / Hora</div><div class="v" id="mTs">‚Äî</div></div>
      <div class="modalActions">
        <button class="btn btnClaim" id="mClaim">üì≤ Reclamar por WhatsApp</button>
        <button class="btn btnGhost" id="mClose">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <!-- TOP -->
  <div class="top">
    <div class="brand">
      <img src="logo-bet300.svg" alt="BET300" id="brandLogo" onerror="this.style.display='none'">
      <div class="brandText">
        <div class="t1">BET300</div>
        <div class="t2">ESPECIAL NAVIDAD</div>
      </div>
    </div>

    <div class="pill">üéÑ Promo interactiva</div>
    <div class="pill">‚ö° Tiempo limitado <b id="countdown">--:--:--</b></div>
    <div class="pill btn" id="soundToggle">üîä Sonido: <b id="soundState">ON</b></div>

    <div class="right">
      <a class="btnLink" id="btnPc" target="_blank" rel="noopener">üéÆ Entrar</a>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="inner">
        <div class="h1">üé° Ruleta Navidad</div>
        <div class="muted">
          Eleg√≠ tu chance: 1 giro por d√≠a. Al ganar se genera un c√≥digo y pod√©s reclamar por WhatsApp.
        </div>

        <div class="wheelWrap">
          <div class="wheelStage" id="stage">
            <div class="rim"></div>
            <div class="bulbs" id="bulbs"></div>
            <div class="pointer"></div>
            <canvas id="wheel" width="900" height="900"></canvas>

            <div class="centerCap">
              <img src="logo-bet300.svg" alt="Logo" onerror="this.style.display='none'">
            </div>
          </div>

          <div class="footerLinks">
            <a href="https://www.bet300.biz/" target="_blank" rel="noopener">üåê Acceso a la plataforma (bet300.biz)</a>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="inner">
        <div class="statRow">
          <div class="badgePrize" id="badge">‚Äî</div>
          <div>
            <p class="bigTitle" id="title">Ten√©s 1 giro disponible</p>
            <p class="muted" id="subtitle">Los premios se acreditan con tu <b>pr√≥xima carga m√≠nima</b>.</p>
          </div>
        </div>

        <div class="panelBox">
          <h3>üìå Resultado</h3>
          <p id="resultLine">‚Äî</p>
          <div class="smallCode" id="stampLine"></div>
        </div>

        <div class="panelBox">
          <h3>üßä Premios posibles</h3>
          <p id="possible"></p>
        </div>

        <div class="panelBox">
          <h3>üîÅ Girar otra vez</h3>
          <p class="muted">Si ya jugaste hoy, te avisa y no te deja repetir.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DOCK -->
<div class="dock">
  <button class="btn btnSpin" id="spinBtn">üéØ Girar</button>
  <button class="btn btnClaim" id="claimBtn" disabled>üì≤ Reclamar</button>
</div>

<script>
/* =========================
   5 PCs (?pc=1..5)
   ========================= */
const PLATFORM_LINKS = {
  pc1: "https://300vip-c01.vercel.app/",
  pc2: "https://300vip-c02.vercel.app/",
  pc3: "https://300vip-c03.vercel.app/",
  pc4: "https://alvge.bet300vip.com/",
  pc5: "https://www.bet300.biz/"
};

const WP_NUMBERS = {
  pc1: "5491171559478",
  pc2: "5491151622581",
  pc3: "5491154040255",
  pc4: "5491150030414",
  pc5: "5491150030414"
};

function normalizeWP(n){
  const s = String(n).replace(/[^\d+]/g,"");
  if(s.startsWith("549")) return s;
  if(s.startsWith("+549")) return s.slice(1);
  if(s.startsWith("+54")) return "549"+s.slice(3);
  if(s.startsWith("54")) return "549"+s.slice(2);
  return "549"+s;
}

const qs = new URLSearchParams(location.search);
const pcParam = (qs.get("pc") || "1").trim();
const pc = /^[1-5]$/.test(pcParam) ? pcParam : "1";
const pcKey = "pc"+pc;

const WP = normalizeWP(WP_NUMBERS[pcKey]);
document.getElementById("btnPc").href = PLATFORM_LINKS[pcKey];

/* =========================
   PREMIOS CORRECTOS
   $1000..$10.000 + % 20..50
   + OTRA CHANCE + DOBLE CARGA
   ========================= */
const PRIZES = [
  { id:"m1000", type:"money",   label:"$1.000", value:1000 },
  { id:"p20",   type:"percent", label:"20%",   value:20 },
  { id:"m2000", type:"money",   label:"$2.000", value:2000 },
  { id:"p30",   type:"percent", label:"30%",   value:30 },
  { id:"m3000", type:"money",   label:"$3.000", value:3000 },
  { id:"p40",   type:"percent", label:"40%",   value:40 },
  { id:"m4000", type:"money",   label:"$4.000", value:4000 },
  { id:"p50",   type:"percent", label:"50%",   value:50 },
  { id:"m5000", type:"money",   label:"$5.000", value:5000 },
  { id:"chance",type:"chance",  label:"OTRA\nCHANCE", value:0 },
  { id:"m10000",type:"money",   label:"$10.000", value:10000 },
  { id:"double",type:"double",  label:"DOBLE\nCARGA", value:0 }
];

document.getElementById("possible").textContent =
  PRIZES.map(p=>p.label.replace("\n"," ")).join(" ¬∑ ");

/* Colores navide√±os */
const COLORS = [
  "#2EA8FF", "#FFD166", "#2AF598", "#FF1E2D",
  "#00C853", "#FFB703", "#32F5FF", "#FF5A3C",
  "#1ED760", "#E11D48", "#60A5FA", "#F59E0B"
];

/* ======================
   UI refs
   ====================== */
const spinBtn  = document.getElementById("spinBtn");
const claimBtn = document.getElementById("claimBtn");
const badge    = document.getElementById("badge");
const titleEl  = document.getElementById("title");
const subEl    = document.getElementById("subtitle");
const resultEl = document.getElementById("resultLine");
const stampEl  = document.getElementById("stampLine");

const modal    = document.getElementById("modal");
const mPrize   = document.getElementById("mPrize");
const mCode    = document.getElementById("mCode");
const mTs      = document.getElementById("mTs");
const mClaim   = document.getElementById("mClaim");
const mClose   = document.getElementById("mClose");
const closeX   = document.getElementById("closeX");

/* ======================
   util
   ====================== */
function todayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

/* ========= antifraude ========= */
const SALT = "bet300-ruleta-nav-v2";
function ensureDeviceId(){
  let id = localStorage.getItem("device_id");
  if(!id){
    id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`);
    localStorage.setItem("device_id", id);
  }
  return id;
}
const DEVICE_ID = ensureDeviceId();

async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeClaimCode(prizeLabel){
  const base = `${DEVICE_ID}|${todayKey()}|${prizeLabel}|pc:${pc}|${SALT}`;
  const hex  = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}

function whatsappText(prizeLabel, code, ts){
  return `Hola, gan√© *${prizeLabel}* en la Ruleta NAVIDAD BET300 üéÑ\n`+
         `C√≥digo: *${code}*\n`+
         `Fecha/Hora: ${ts}\n\n`+
         `¬øMe confirm√°s condiciones y m√≠nima de carga?`;
}

/* ========= Modal ========= */
function openModal(prizeLabel, code, ts){
  mPrize.textContent = prizeLabel;
  mCode.textContent  = code;
  mTs.textContent    = ts;
  mClaim.onclick = ()=> location.href = `https://wa.me/${WP}?text=${encodeURIComponent(whatsappText(prizeLabel, code, ts))}`;
  modal.classList.add("show");
}
function closeModal(){ modal.classList.remove("show"); }
mClose.onclick = closeModal;
closeX.onclick = closeModal;
modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });

/* ========= Snow / confetti ========= */
function setupSnow(){
  const snow=document.getElementById("snow");
  snow.innerHTML="";
  const flakes=44;
  for(let i=0;i<flakes;i++){
    const f=document.createElement("i");
    const size=3+Math.random()*4;
    f.style.width=f.style.height=size+"px";
    f.style.left=(Math.random()*100)+"vw";
    f.style.opacity=(0.45+Math.random()*0.55).toFixed(2);
    f.style.animationDuration=(7+Math.random()*7)+"s";
    f.style.animationDelay=(Math.random()*-10)+"s";
    f.style.setProperty("--drift",(Math.random()*44-22)+"px");
    snow.appendChild(f);
  }
}
function confettiBurst(){
  const el=document.getElementById("confetti");
  el.innerHTML="";
  const n=32;
  for(let i=0;i<n;i++){
    const p=document.createElement("i");
    p.style.left=(Math.random()*100)+"vw";
    p.style.animationDelay=(Math.random()*0.5)+"s";
    p.style.background = (Math.random()<.5)
      ? "linear-gradient(#32F5FF,#2EA8FF)"
      : "linear-gradient(#FFD166,#FF1E2D)";
    el.appendChild(p);
  }
  setTimeout(()=>{ el.innerHTML=""; }, 1700);
}

/* ========= Bulbs ========= */
function placeBulbs(){
  const bulbs=document.getElementById("bulbs");
  const stage=document.getElementById("stage");
  bulbs.innerHTML="";
  const rect=stage.getBoundingClientRect();
  const w=rect.width, h=rect.height;
  const count=34;
  for(let i=0;i<count;i++){
    const a=(Math.PI*2)*(i/count);
    const r=Math.min(w,h)/2 - 18;
    const x=w/2 + Math.cos(a)*r;
    const y=h/2 + Math.sin(a)*r;
    const b=document.createElement("i");
    b.style.left=(x-4)+"px";
    b.style.top=(y-4)+"px";
    b.style.background = (i%3===0) ? "#FFD166" : (i%3===1) ? "#2EA8FF" : "#00C853";
    b.style.animationDuration = (900 + (i%6)*120) + "ms";
    bulbs.appendChild(b);
  }
}

/* ========= Countdown ========= */
function endOfDay(){
  const n=new Date();
  return new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59).getTime();
}
function tickCountdown(){
  const ms=endOfDay()-Date.now();
  const total=Math.max(0,Math.floor(ms/1000));
  const h=Math.floor(total/3600);
  const m=Math.floor((total%3600)/60);
  const s=total%60;
  document.getElementById("countdown").textContent =
    `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

/* ========= Persistencia diaria ========= */
function restoreDaily(){
  const today=todayKey();
  const stored=localStorage.getItem("wheel_date");
  if(stored && stored!==today){
    localStorage.removeItem("wheel_done");
    localStorage.removeItem("wheel_prize");
    localStorage.removeItem("wheel_code");
    localStorage.removeItem("wheel_ts");
    localStorage.setItem("wheel_date",today);
  }else if(!stored){
    localStorage.setItem("wheel_date",today);
  }
}
function restorePrizeIfAny(){
  const done=localStorage.getItem("wheel_done")==="1";
  const p=localStorage.getItem("wheel_prize");
  if(done && p){
    const prize=JSON.parse(p);
    const code=localStorage.getItem("wheel_code")||"‚Äî";
    const ts=localStorage.getItem("wheel_ts")||tsString();

    badge.textContent = prize.label.replace("\n"," ");
    titleEl.textContent="üéâ ¬°Premio obtenido!";
    subEl.innerHTML = `Te qued√≥ asignado <b>${prize.label.replace("\n"," ")}</b>.`;
    resultEl.textContent = `Premio: ${prize.label.replace("\n"," ")}`;
    stampEl.textContent  = `C√≥digo: ${code} ¬∑ ${ts}`;

    claimBtn.disabled=false;
    spinBtn.disabled=true;

    claimBtn.onclick=()=> location.href=`https://wa.me/${WP}?text=${encodeURIComponent(whatsappText(prize.label.replace("\n"," "), code, ts))}`;
  }
}
function scheduleMidnightReset(){
  const now=new Date();
  const next=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,3);
  setTimeout(()=>{
    localStorage.removeItem("wheel_done");
    localStorage.removeItem("wheel_prize");
    localStorage.removeItem("wheel_code");
    localStorage.removeItem("wheel_ts");
    localStorage.setItem("wheel_date",todayKey());
    badge.textContent="‚Äî";
    titleEl.textContent="Ten√©s 1 giro disponible";
    subEl.innerHTML="Los premios se acreditan con tu <b>pr√≥xima carga m√≠nima</b>.";
    resultEl.textContent="‚Äî";
    stampEl.textContent="";
    spinBtn.disabled=false;
    claimBtn.disabled=true;
  }, next.getTime()-now.getTime());
}

/* ========= Sonido ========= */
let soundOn=true;
const soundToggle=document.getElementById("soundToggle");
const soundState=document.getElementById("soundState");

const AudioKit=(()=> {
  const Ctx=window.AudioContext||window.webkitAudioContext;
  const ctx=new Ctx();
  let unlocked=false;
  function unlock(){ if(!unlocked){ ctx.resume().catch(()=>{}); unlocked=true; } }
  function blip(freq=880,dur=0.06,vol=0.05,type="sine"){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.value=0.0001;
    o.connect(g).connect(ctx.destination);
    const t=ctx.currentTime;
    g.gain.linearRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.start(t); o.stop(t+dur);
  }
  function spinTick(){ blip(720+Math.random()*260,0.035,0.05,"square"); }
  function win(){ [660,880,1100].forEach((f,i)=>setTimeout(()=>blip(f,0.12,0.08,"triangle"), i*120)); }
  return {unlock,spinTick,win};
})();

document.addEventListener("click",()=>AudioKit.unlock(),{once:true});
soundToggle.addEventListener("click",()=>{
  soundOn=!soundOn;
  soundState.textContent = soundOn ? "ON" : "OFF";
});

/* =========================
   RULETA CANVAS (pro + legible)
   ========================= */
const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");
let angle=-Math.PI/2;
let spinning=false;

function fitCanvas(){
  const dpr=Math.max(1, window.devicePixelRatio||1);
  const rect=canvas.getBoundingClientRect();
  const size=Math.floor(Math.min(rect.width, rect.height)*dpr);
  canvas.width=size; canvas.height=size;
  drawWheel(angle);
}
window.addEventListener("resize",()=>{ clearTimeout(window.__rs); window.__rs=setTimeout(()=>{fitCanvas(); placeBulbs();},120); });

function drawWheel(a){
  const w=canvas.width, h=canvas.height;
  const cx=w/2, cy=h/2;
  ctx.clearRect(0,0,w,h);

  const R=Math.min(w,h)*0.49;
  const step=(Math.PI*2)/PRIZES.length;

  // sombra base
  ctx.save();
  ctx.translate(cx,cy);
  ctx.beginPath(); ctx.arc(0,0,R,0,Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,.20)";
  ctx.fill();
  ctx.restore();

  // segmentos
  for(let i=0;i<PRIZES.length;i++){
    const start=a + i*step;
    const end=start + step;

    ctx.save();
    ctx.translate(cx,cy);
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,R, start, end);
    ctx.closePath();

    const col=COLORS[i%COLORS.length];
    const segGrad=ctx.createLinearGradient(
      Math.cos(start)*R*0.2, Math.sin(start)*R*0.2,
      Math.cos(end)*R, Math.sin(end)*R
    );
    segGrad.addColorStop(0, col);
    segGrad.addColorStop(1, "rgba(0,0,0,.10)");
    ctx.fillStyle=segGrad;
    ctx.fill();

    ctx.strokeStyle="rgba(0,0,0,.22)";
    ctx.lineWidth=Math.max(2, R*0.006);
    ctx.stroke();

    // texto
    const mid=(start+end)/2;
    const rText=R*0.70;

    ctx.rotate(mid);

    // evitar texto dado vuelta
    const deg = (mid*180/Math.PI)%360;
    const upside = (deg>90 && deg<270);
    if(upside) ctx.rotate(Math.PI);

    ctx.textAlign="center";
    ctx.textBaseline="middle";

    const label=PRIZES[i].label;
    const isTwo=label.includes("\n");
    const fontSize=Math.floor(R*(isTwo ? 0.070 : 0.082));
    ctx.font=`900 ${fontSize}px Montserrat, system-ui`;

    // sombra/contraste para que se lea SIEMPRE
    ctx.fillStyle="rgba(7,10,22,.92)";
    ctx.shadowColor="rgba(255,255,255,.20)";
    ctx.shadowBlur=7;

    if(isTwo){
      const [l1,l2]=label.split("\n");
      ctx.fillText(l1, rText, -fontSize*0.42);
      ctx.fillText(l2, rText,  fontSize*0.42);
    }else{
      ctx.fillText(label, rText, 0);
    }

    ctx.restore();
  }

  // aro interior + brillo
  ctx.save();
  ctx.translate(cx,cy);
  const inner=R*0.20;
  const g=ctx.createRadialGradient(0,0,inner*0.2, 0,0,inner*2.0);
  g.addColorStop(0,"rgba(255,255,255,.14)");
  g.addColorStop(1,"rgba(0,0,0,.40)");
  ctx.beginPath(); ctx.arc(0,0,inner*1.55,0,Math.PI*2);
  ctx.fillStyle=g;
  ctx.fill();
  ctx.lineWidth=Math.max(2, R*0.012);
  ctx.strokeStyle="rgba(255,209,102,.22)";
  ctx.stroke();

  // brillo superior
  ctx.beginPath();
  ctx.arc(0,0,R*0.98, -Math.PI*0.95, -Math.PI*0.05);
  ctx.strokeStyle="rgba(255,255,255,.16)";
  ctx.lineWidth=Math.max(2, R*0.022);
  ctx.lineCap="round";
  ctx.stroke();
  ctx.restore();
}

function pickPrizeByAngle(a){
  const step=(Math.PI*2)/PRIZES.length;
  const normalized=((a%(Math.PI*2))+(Math.PI*2))%(Math.PI*2);
  const pointerAngle=(Math.PI*1.5); // -PI/2 normalizado
  let diff=pointerAngle - normalized;
  diff=(diff + Math.PI*2)%(Math.PI*2);
  const idx=Math.floor(diff/step)%PRIZES.length;
  return { idx, prize: PRIZES[idx] };
}

async function doSpin(){
  if(spinning) return;

  if(localStorage.getItem("wheel_done")==="1"){
    alert("‚ö†Ô∏è Ya usaste tu chance hoy. Volv√© ma√±ana üòâ");
    return;
  }

  spinning=true;
  spinBtn.disabled=true;
  claimBtn.disabled=true;

  const targetIdx=Math.floor(Math.random()*PRIZES.length);
  const step=(Math.PI*2)/PRIZES.length;
  const pointer=-Math.PI/2;
  const targetMid = pointer - (targetIdx + 0.5)*step;

  const turns=7 + Math.random()*2.5;
  const targetAngle = targetMid + turns*(Math.PI*2) + (Math.random()*0.08 - 0.04);

  const start=performance.now();
  const dur=5200 + Math.random()*600;
  const a0=angle;
  const delta=targetAngle - a0;

  const tickEvery=90;
  let lastTick=0;
  const easeOutCubic=t=>1-Math.pow(1-t,3);

  function anim(now){
    const t=Math.min(1,(now-start)/dur);
    const e=easeOutCubic(t);
    angle=a0 + delta*e;
    drawWheel(angle);

    if(soundOn && (now-lastTick)>tickEvery){
      AudioKit.spinTick();
      lastTick=now;
    }
    if(t<1) requestAnimationFrame(anim);
    else finishSpin();
  }
  requestAnimationFrame(anim);
}

async function finishSpin(){
  const { prize } = pickPrizeByAngle(angle);

  const ts=tsString(new Date());
  const code=await makeClaimCode(prize.label.replace("\n"," "));

  localStorage.setItem("wheel_done","1");
  localStorage.setItem("wheel_prize", JSON.stringify(prize));
  localStorage.setItem("wheel_code", code);
  localStorage.setItem("wheel_ts", ts);

  const nice = prize.label.replace("\n"," ");
  badge.textContent = nice;
  titleEl.textContent="üéâ ¬°Premio obtenido!";
  subEl.innerHTML = `Ganaste <b>${nice}</b>.`;
  resultEl.textContent = `Premio: ${nice}`;
  stampEl.textContent  = `C√≥digo: ${code} ¬∑ ${ts}`;

  claimBtn.disabled=false;
  claimBtn.onclick=()=> location.href=`https://wa.me/${WP}?text=${encodeURIComponent(whatsappText(nice, code, ts))}`;

  if(soundOn) AudioKit.win();
  confettiBurst();
  openModal(nice, code, ts);

  spinning=false;
}

spinBtn.addEventListener("click", doSpin);

/* Init */
function init(){
  restoreDaily();
  setupSnow();
  tickCountdown();
  setInterval(tickCountdown, 1000);
  scheduleMidnightReset();

  fitCanvas();
  placeBulbs();
  drawWheel(angle);

  restorePrizeIfAny();
}
init();
</script>
</body>
</html>
